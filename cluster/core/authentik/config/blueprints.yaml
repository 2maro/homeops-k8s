apiVersion: v1
kind: ConfigMap
metadata:
  name: authentik-blueprints
  namespace: authentik
data:
  full-setup.yaml: |
    version: 1
    metadata:
      name: Home Lab Infrastructure
      labels:
        blueprints.goauthentik.io/instantiate: "true"
    entries:
      # 1. ADMIN USER & GROUP
      - model: authentik_core.user
        id: admin-user
        identifiers:
          username: admin
        attrs:
          name: Admin
          email: 2marotech@gmail.com
          is_active: true
          path: users
          type: internal

      - model: authentik_core.group
        identifiers:
          name: Admins
        attrs:
          is_superuser: true
          users:
            - !KeyOf admin-user

      # 2. PROXY PROVIDERS
      # ---------------------------------------------------------
      # Firefly (Special: includes Property Mappings for Headers)
      - model: authentik_providers_proxy.proxyprovider
        id: prov-firefly
        identifiers:
          name: Firefly III
        attrs:
          mode: proxy
          external_host: https://firefly.k8s.home.lab
          internal_host: http://firefly-main.firefly.svc.cluster.local:8080
          authorization_flow: !Find [authentik_flows.flow, [slug, default-provider-authorization-implicit-consent]]
          invalidation_flow: !Find [authentik_flows.flow, [slug, default-provider-invalidation-flow]]
          property_mappings:
            - !Find [authentik_core.propertymapping, [managed, goauthentik.io/providers/proxy/scope-username]]
            - !Find [authentik_core.propertymapping, [managed, goauthentik.io/providers/proxy/scope-email]]

      - model: authentik_providers_proxy.proxyprovider
        id: prov-grafana
        identifiers:
          name: Grafana
        attrs:
          mode: proxy
          external_host: https://grafana.k8s.home.lab
          internal_host: http://kube-prometheus-stack-grafana.monitoring.svc.cluster.local:80
          authorization_flow: !Find [authentik_flows.flow, [slug, default-provider-authorization-implicit-consent]]
          invalidation_flow: !Find [authentik_flows.flow, [slug, default-provider-invalidation-flow]]

      - model: authentik_providers_proxy.proxyprovider
        id: prov-prometheus
        identifiers:
          name: Prometheus
        attrs:
          mode: proxy
          external_host: https://prometheus.k8s.home.lab
          internal_host: http://prometheus-kube-prometheus-stack-prometheus.monitoring.svc.cluster.local:9090
          authorization_flow: !Find [authentik_flows.flow, [slug, default-provider-authorization-implicit-consent]]
          invalidation_flow: !Find [authentik_flows.flow, [slug, default-provider-invalidation-flow]]

      - model: authentik_providers_proxy.proxyprovider
        id: prov-alertmanager
        identifiers:
          name: Alertmanager
        attrs:
          mode: proxy
          external_host: https://alertmanager.k8s.home.lab
          internal_host: http://alertmanager-kube-prometheus-stack-alertmanager.monitoring.svc.cluster.local:9093
          authorization_flow: !Find [authentik_flows.flow, [slug, default-provider-authorization-implicit-consent]]
          invalidation_flow: !Find [authentik_flows.flow, [slug, default-provider-invalidation-flow]]

      - model: authentik_providers_proxy.proxyprovider
        id: prov-syncthing
        identifiers:
          name: Syncthing
        attrs:
          mode: proxy
          external_host: https://syncthing.k8s.home.lab
          internal_host: http://syncthing-app.syncthing.svc.cluster.local:8384
          authorization_flow: !Find [authentik_flows.flow, [slug, default-provider-authorization-implicit-consent]]
          invalidation_flow: !Find [authentik_flows.flow, [slug, default-provider-invalidation-flow]]

      - model: authentik_providers_proxy.proxyprovider
        id: prov-jellyfin
        identifiers:
          name: Jellyfin
        attrs:
          mode: proxy
          external_host: https://jellyfin.k8s.home.lab
          internal_host: http://jellyfin.jellyfin.svc.cluster.local:8096
          authorization_flow: !Find [authentik_flows.flow, [slug, default-provider-authorization-implicit-consent]]
          invalidation_flow: !Find [authentik_flows.flow, [slug, default-provider-invalidation-flow]]

      - model: authentik_providers_proxy.proxyprovider
        id: prov-qbittorrent
        identifiers:
          name: qBittorrent
        attrs:
          mode: proxy
          external_host: https://qbittorrent.k8s.home.lab
          internal_host: http://qbittorrent-main.qbittorrent.svc.cluster.local:8080
          authorization_flow: !Find [authentik_flows.flow, [slug, default-provider-authorization-implicit-consent]]
          invalidation_flow: !Find [authentik_flows.flow, [slug, default-provider-invalidation-flow]]

      # 3. APPLICATIONS
      # ---------------------------------------------------------
      - model: authentik_core.application
        identifiers:
          slug: firefly
        attrs:
          name: Firefly III
          provider: !KeyOf prov-firefly
          meta_launch_url: https://firefly.k8s.home.lab

      - model: authentik_core.application
        identifiers:
          slug: grafana
        attrs:
          name: Grafana
          provider: !KeyOf prov-grafana
          meta_launch_url: https://grafana.k8s.home.lab

      - model: authentik_core.application
        identifiers:
          slug: prometheus
        attrs:
          name: Prometheus
          provider: !KeyOf prov-prometheus
          meta_launch_url: https://prometheus.k8s.home.lab

      - model: authentik_core.application
        identifiers:
          slug: alertmanager
        attrs:
          name: Alertmanager
          provider: !KeyOf prov-alertmanager
          meta_launch_url: https://alertmanager.k8s.home.lab

      - model: authentik_core.application
        identifiers:
          slug: syncthing
        attrs:
          name: Syncthing
          provider: !KeyOf prov-syncthing
          meta_launch_url: https://syncthing.k8s.home.lab

      - model: authentik_core.application
        identifiers:
          slug: jellyfin
        attrs:
          name: Jellyfin
          provider: !KeyOf prov-jellyfin
          meta_launch_url: https://jellyfin.k8s.home.lab

      - model: authentik_core.application
        identifiers:
          slug: qbittorrent
        attrs:
          name: qBittorrent
          provider: !KeyOf prov-qbittorrent
          meta_launch_url: https://qbittorrent.k8s.home.lab

      # 4. OUTPOST CONFIGURATION (Redirect Fix)
      # ---------------------------------------------------------
      - model: authentik_outposts.outpost
        identifiers:
          name: authentik Embedded Outpost
        attrs:
          type: proxy
          providers:
            - !KeyOf prov-firefly
            - !KeyOf prov-grafana
            - !KeyOf prov-prometheus
            - !KeyOf prov-alertmanager
            - !KeyOf prov-syncthing
            - !KeyOf prov-jellyfin
            - !KeyOf prov-qbittorrent
          config:
            authentik_host: https://auth.k8s.home.lab
            authentik_host_insecure: true
